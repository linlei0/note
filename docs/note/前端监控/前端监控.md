# å‰ç«¯æ€§èƒ½ç›‘æ§

 ## ä¸ºä»€ä¹ˆè¦åšå‰ç«¯ç›‘æ§
 - æ›´å¿«çš„å‘ç°é—®é¢˜å’Œè§£å†³é—®é¢˜
 - åšäº§å“çš„å†³ç­–ä¾æ®
 - ä¸ºä¸šåŠ¡æ‰©å±•æä¾›æ›´å¤šçš„å¯èƒ½æ€§

## å‰ç«¯ç›‘æ§ç›®æ ‡
- ç¨³å®šæ€§
jsé”™è¯¯     jsæ‰§è¡Œé”™è¯¯æˆ–è€…
èµ„æºå¼‚å¸¸    scriptå’Œlinkèµ„æºåŠ è½½å¼‚å¸¸
æ¥å£é”™è¯¯    ajaxæˆ–fetchè¯·æ±‚å¼‚å¸¸
ç™½å±       é¡µé¢ç©ºç™½æ—¶é—´

- ç”¨æˆ·ä½“éªŒ
åŠ è½½æ—¶é—´                                        å„ä¸ªé˜¶æ®µçš„åŠ è½½æ—¶é—´
TTFBï¼ˆtime to firstï¼‰é¦–å­—èŠ‚æ—¶é—´                  æ˜¯æŒ‡æµè§ˆå™¨å‘èµ·ç¬¬ä¸€ä¸ªè¯·æ±‚åˆ°æ•°æ®è¿”å›ç¬¬ä¸€ä¸ªå­—èŠ‚æ‰€æ¶ˆè€—çš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´åŒ…å¥½äº†ç½‘ç»œè¯·æ±‚
FPï¼ˆfirst Paintï¼‰é¦–æ¬¡ç»˜åˆ¶                        é¦–æ¬¡ç»˜åˆ¶åŒ…æ‹¬ä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰çš„èƒŒæ™¯ç»˜åˆ¶ï¼Œä»–æ˜¯å°†ç¬¬ä¸€ä¸ªåƒç´ ç‚¹ç»˜åˆ¶åˆ°å±å¹•çš„æ—¶é—´
FCPï¼ˆfirst Content Paintï¼‰é¦–æ¬¡å†…å®¹ç»˜åˆ¶            ç¬¬ä¸€ä¸ªdomæ¸²æŸ“åˆ°å±å¹•çš„æ—¶é—´å¯ä»¥æ˜¯æ–‡æœ¬ï¼Œå›¾ç‰‡ï¼Œsvgç­‰çš„æ—¶é—´
FMPï¼ˆfirst Meaningful paintï¼‰é¦–æ¬¡æœ‰æ„ä¹‰çš„ç»˜åˆ¶     é¦–æ¬¡ç»˜åˆ¶æœ‰æ„ä¹‰çš„ç»˜åˆ¶æ˜¯é¡µé¢å¯ç”¨æ€§çš„åº¦é‡æ ‡å‡†
FIDï¼ˆfirst input Delaryï¼‰é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ            ç”¨æˆ·é¦–æ¬¡å’Œé¡µé¢äº¤äº’åˆ°é¡µé¢å“åº”äº¤äº’æ—¶é—´
å¡é¡¿                                           è¶…è¿‡50msçš„é•¿ä»»åŠ¡

- ä¸šåŠ¡
PV             page view é¡µé¢çš„æµè§ˆé‡
UV             æŒ‡è®¿é—®æŸä¸ªç«™ç‚¹çš„ä¸åŒipåœ°å€çš„äººæ•°
é¡µé¢åœç•™æ—¶é—´     ç”¨æˆ·åœ¨æ¯ä¸ªé¡µé¢åœç•™çš„æ—¶é—´

## å‰ç«¯ç›‘æ§æµç¨‹


### æ­å»ºSDK
SDKæ¶æ„å›¾
![SDKæ¶æ„å›¾](./image/sdk.jpg)
### é”™è¯¯ç›‘æ§SDK
#### jsError
 - ä¸»åŠ¨è§¦å‘
    ```js
        window.addEventListener('error', function(e) {
            console.log(Array.prototype.slice.call(arguments)[0])
        })
        function testErr() {
            c.l = 1
        }
    ```
 - æ‰‹åŠ¨è§¦å‘
    ```js
     try {
        throw new Error('error!!')
    } catch(err) {
        console.log(err.message)
    }
    ```

#### promiseError

```js

  window.addEventListener('unhandledrejection', function(error) {
        // console.log(reason, promise)
        if(typeof reason === 'string') {
            // å¦‚æœæ˜¯promiseè¿”å›çš„æ˜¯rejectåˆ™è¿›å…¥è¿™é‡Œ
        } else {
            // reason.stack å¯ä»¥è·å–åˆ°å…·ä½“çš„é”™è¯¯è¡Œæ•°
            console.log(error.reason)
        }
    })
    Promise.resolve(()=> {
        return {}
    }).then((data)=> {
        // console.log(data)
        throw new Error('error!!')
    })
```

**æ€è€ƒğŸ¤”:ä¸ºä»€ä¹ˆwindow.onerroræ— æ³•ç›‘æ§promiseçš„é”™è¯¯?**

ä¸»è¦åŸå› ï¼šwindow.onerrorä¸»è¦æ˜¯ç›‘æ§å®ä»»åŠ¡çš„é”™è¯¯æ—¥å¿—ï¼Œè€Œpromsieå±äºå¾®ä»»åŠ¡

### å¦‚ä½•ç›‘æ§httpè¯·æ±‚
```js
function injectXHR() {
    let XMLHttpRequest = window.XMLHttpRequest;
    let oldOpen = XMLHttpRequest.prototype.open;
     XMLHttpRequest.prototype.open = function(method, url, async) {
        // åœ¨è¿™é‡Œè¿›è¡Œä¸ŠæŠ¥æ•°æ®å¤„ç†
        this.loData = {
            appid: 'app123',
            pageid: 'page123'
        }
        return oldOpen.apply(this, arguments)
     }
     let oldSend = XMLHttpRequest.prototype.send;
     XMLHttpRequest.prototype.send = function(body) {
        if(this.loData) {
            let startTime = Date.now()
            const  handler =(type)=> {
                return (event)=> {
                    let duration = Date.now - startTime;
                    let status = this.status;
                    let statusText = this.statusText;
                    // å‘é€æ•°æ®å³å¯
                    // ...
                }
            }
            this.addEventListener('load', handler('load'), false);
            this.addEventListener('error', handler('load'), false);
            this.addEventListener('abort', handler('load'), false);
        }
        return oldSend.apply(this, arguments)
     }     
}
```

### ç™½å±ç›‘æ§
å®ç°æ€è·¯ï¼š
- å°†å±å¹•åˆ†æˆè‹¥å¹²ç‚¹è¿™é‡Œä»¥18ä¸ªç‚¹æ¥å¤„ç†
- è·å–æ”¹ç‚¹ä¸‹çš„ç±»åæˆ–è€…idï¼Œå¦‚æœè¯¥ç‚¹è¿”å›wrapperElementsåˆ™è¯´æ˜è¯¥å¤„ç™½å±ï¼Œå¹¶è¿›è¡Œä¸€æ¬¡emptyPoint++æ“ä½œ
- éœ€è¦æ³¨æ„è¯¥å¤„è°ƒç”¨åº”è¯¥æ˜¯åœ¨loadä¹‹å
```js

function blankScreen() {
    let emptyPoint = 0;
    // é¡µé¢çš„é€‰æ‹©å™¨
    const wrapperElements = ['html', 'body', '#main']
    const isWrapper = (element)=> {
        let selector = getSelector(element)
        if(wrapperElements.includes(selector)) {
            emptyPoint++
        }
    }
    const getSelector = (element) => {
        if(element.id) {
            return '#' + element.id;
        } else if(element.className) {
            return '.' + element.className.split(' ').join('.')
        } else {
            return element.nodeName.toLowerCase()
        }
    }
    // å°†å±å¹•åˆ†æˆ18ä¸ªç‚¹
    for(let i=0;i<10;i++) {
        let xElements = document.elementsFromPoint(
            window.innerWidth * i / 10, window.innerHeight / 2
        )
        let yElements = document.elementsFromPoint(
            window.innerHeight * i / 10, window.innerWidth / 2
        )
        isWrapper(xElements[0])
        isWrapper(yElements[0])
    }
    // ç™½å±
    if(emptyPoint >= 18) {
        // å‘é€æ•°æ®
    }
}

// load

function onload(cb) {
    if(document.readystate==='complete') {
        cb()
    } else {
        window.addEventListener('load', cb)
    }
}
onload(blankScreen)

```

[document.elementsFromPointå‚è€ƒ](https://developer.mozilla.org/zh-CN/docs/Web/API/Document/elementsFromPoint)

### æ€§èƒ½æ•°æ®é‡‡é›†
é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“åˆ°åº•åˆ°åº•æœ‰å“ªäº›æŒ‡æ ‡
![å‰ç«¯æ€§èƒ½](./image/performance.png)
ç”±ä¸Šå›¾æˆ‘ä»¬å¯ä»¥è®¡ç®—ç›¸å…³çš„å‚æ•°å¦‚ï¼šDNSè§£ææ—¶é—´ï¼ŒDOMåŠ è½½æ—¶é—´ç­‰
![å‰ç«¯æ€§èƒ½å‚æ•°](./image/performanceparams.png)
eg: å¦‚ä¸‹æˆ‘ä»¬å¯ä»¥è·å–ç›¸åº”çš„å‚æ•°
```js
function getPerformance() {
    const {
        fetchStart,
        connetstart,
        connectEnd,
        requestStart,
        requestEnd,
        responseStart,
        responseEnd,
        domLoading,
        domInteractive,
        domContentLoadedEventStart,
        domContentLoadedEventEnd,
        loadEventStart
    } = widnow.performance.timing;

    return {
        connectTime: connectEnd - connetstart, //è¿æ¥æ—¶é—´
        ttfbTime: requestEnd - requestStart, // é¦–å­—èŠ‚åˆ°è¾¾æ—¶é—´
        responseTime: responseEnd - responseEnd, // å“åº”çš„è¯»å–æ—¶é—´
        parseDOMTime: loadEventStart - domLoading, // domè§£ææ—¶é—´
        domContentLoadTime: domContentLoadedEventEnd - domContentLoadedEventStart, // domåŠ è½½æ—¶é—´
        timeToInteractive:  domInteractive - fetchStart, // é¦–æ¬¡å¯äº¤äº’æ—¶é—´
        loadTime: loadEventStart - fetchStart, // å®Œæ•´çš„åŠ è½½æ—¶é—´

    }
}
onload(getPerformance)
```

æœ‰äº†ä¸Šé¢çš„æ–¹æ³•ä»‹ç»æˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“çš„è·å–ç›¸å…³å‚æ•°ï¼Œä½†æ˜¯**performance.timing**å¹¶ä¸å¤Ÿç²¾ç¡®ï¼Œä¸€èˆ¬ä½¿ç”¨**PerformanceObserver**;
```js
function observer_callback(list, observer) {
  list.getEntries().forEach(e => {
    console.log(e);
  });
  observer.disconnect()
}
// FPï¼ŒFCP
new PerformanceObserver(observer_callback).observe({
    entryTypes: ['paint']
})
//  LCP
new PerformanceObserver(observer_callback).observe({
    entryTypes: ['largest-contentful-paint']
})
// FMP
new PerformanceObserver(observer_callback).observe({
    entryTypes: ['element']
})
// è·å–FMPéœ€è¦ç»™æŒ‡å®šçš„domæ·»åŠ å‚æ•°
// dom.setAttribute("elementtiming","meaningful")
// FID  é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ
new PerformanceObserver(observer_callback).observe({
    entryTypes: ['first-input']
})
// source
new PerformanceObserver(observer_callback).observe({
    entryTypes: ['source']
})
```

[performance.timingæ–‡æ¡£](https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceTiming)
[PerformanceObserveræ–‡æ¡£](https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceObserver/PerformanceObserver)

### æ›å…‰é‡‡é›†

å®ç°æ›å…‰ä¸€èˆ¬ä½¿ç”¨**IntersectionObserver**å®ç°ï¼Œå½“ç„¶é™¤äº†è¯¥APIæµè§ˆå™¨ä¹Ÿæä¾›äº†å…¶ä»–çš„API

æ‰©å±•çŸ¥è¯†
- IntersectionObserver 
    ç›‘å¬ä¸€ä¸ªå…ƒç´ å’Œå¯è§†åŒºåŸŸç›¸äº¤éƒ¨åˆ†çš„æ¯”ä¾‹ï¼Œç„¶ååœ¨å¯è§†æ¯”ä¾‹è¾¾åˆ°æŸä¸ªé˜ˆå€¼çš„æ—¶å€™è§¦å‘å›è°ƒ
- MutationObserver
    ç›‘å¬ DOM æ ‘çš„å˜åŒ–ï¼ˆå±æ€§ã€å­èŠ‚ç‚¹çš„å¢åˆ æ”¹ï¼‰æ¯”å¦‚æˆ‘ä»¬å¯ä»¥å»åšå›æº¯
- PerformanceObserver 
    ç”¨äºç›‘æµ‹æ€§èƒ½åº¦é‡äº‹ä»¶ï¼Œåœ¨æµè§ˆå™¨çš„æ€§èƒ½æ—¶é—´è½´è®°å½•ä¸‹ä¸€ä¸ªæ–°çš„ performance entries çš„æ—¶å€™å°†ä¼šè¢«é€šçŸ¥ã€‚å¯ä»¥ç›‘æ§æ€§èƒ½

- ResizeObserver 
    æ¥å£å¯ä»¥ç›‘å¬åˆ° DOM çš„å˜åŒ–ï¼ˆèŠ‚ç‚¹çš„å‡ºç°å’Œéšè—ï¼ŒèŠ‚ç‚¹å¤§å°çš„å˜åŒ–ï¼‰
- ReportingObserver
    ReportingObserver: ç›‘å¬è¿‡æ—¶çš„ apiã€æµè§ˆå™¨çš„ä¸€äº›å¹²é¢„è¡Œä¸ºçš„æŠ¥å‘Š

```js

    export function collectAppear() {
  const appearEvent = new CustomEvent('onAppear');
  const disappearEvent = new CustomEvent('onDisappear');
  let ob;
  if (window.ImoocCliMonitorObserver) {
    ob = window.ImoocCliMonitorObserver;
  } else {
    ob = new IntersectionObserver(function(e) {
      e.forEach(d => {
        if (d.intersectionRatio > 0) {
          console.log(d.target.className + ' appear');
          d.target.dispatchEvent(appearEvent);
        } else {
          console.log(d.target.className + ' disappear');
          d.target.dispatchEvent(disappearEvent);
        }
      });
    });
  }
  let obList = [];
  const appear = document.querySelectorAll('[appear]');
  for (let i = 0; i < appear.length; i++) {
    if (!obList.includes(appear[i])) {
      ob.observe(appear[i]);
      obList.push(appear[i]);
    }
  }
  window.MonitorObserver = ob;
  window.MonitorObserverList = obList;
}



document.getElementsByClassName('demo2')[0].addEventListener('onAppear', function(e) {
    // sendExp({ a: 1, b: 2 }, e);
  });

```

